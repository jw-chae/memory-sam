# Memory SAM 업데이트

이 문서는 Memory SAM 시스템에 대한 최근 업데이트에 대해 설명합니다.

## 1. 코드 리팩토링

기존의 `memory_gradio_interface.py` 파일은 여러 기능이 하나의, 긴 파일에 섞여 있어 코드 관리가 어려웠습니다. 이를 해결하기 위해 코드를 다음과 같이 독립적인 모듈로 분리했습니다:

1. **memory_ui_utils.py**: 공통 유틸리티 함수
   - 마스크 시각화, 파일 처리 등 여러 모듈에서 공유하는 유틸리티 함수

2. **segmentation_module.py**: 메모리 기반 세그멘테이션 모듈
   - 입력 이미지 처리
   - DINOv2와 SAM2를 사용한 세그멘테이션
   - 결과 시각화 및 저장

3. **mask_generator_module.py**: 마스크 생성 모듈
   - 수동 포인트 및 박스 프롬프트 처리
   - 마스크 생성 및 시각화
   - 메모리 저장 기능

4. **memory_manager_module.py**: 메모리 관리 모듈
   - 메모리 아이템 조회 및 표시
   - 메모리 통계 관리
   - 특징 매칭 시각화

이렇게 모듈화된 구조로 각 기능을 독립적으로 관리하고 확장할 수 있게 되었습니다.

## 2. 배경 영역 스파스 매칭 추가

기존 스파스 매칭 기능은 전경(마스크 영역)에 대해서만 수행되었습니다. 이번 업데이트에서는 배경 영역(마스크가 아닌 부분)에 대한 스파스 매칭 기능을 추가했습니다:

1. **배경 매칭 기능**:
   - 배경 영역에 대한 특징 매칭을 추가하여 더 정확한 세그멘테이션을 제공
   - 이 기능은 negative 정보를 제공하여 정확한 영역 분할을 지원
   - UI에서 "배경 영역 매칭" 옵션으로 활성화/비활성화 가능

2. **전경/배경 결합 유사도 계산**:
   - 전경과 배경의 매칭 결과를 가중치로 결합 (기본 가중치 전경:배경 = 0.7:0.3)
   - 전경 매칭과 배경 매칭의 상세 정보를 UI에 표시

3. **메모리 시스템 확장**:
   - 전경/배경에 대한 개별 유사도, 매치 비율, 평균 거리 등 상세 정보 제공
   - `get_most_similar_sparse` 메서드에 `match_background` 매개변수 추가

## 사용 방법

### 새로운 UI 사용법

1. **메모리 기반 세그멘테이션 탭**:
   - "스파스 매칭 사용" 옵션을 체크하여 DINOv2 패치 특징 기반 스파스 매칭을 활성화
   - "배경 영역 매칭" 옵션을 체크하여 배경 영역 매칭을 활성화 (negative 정보 활용)

2. **메모리 관리 탭**:
   - 메모리 항목 선택 시, 특징 매칭 시각화 탭에서 전경/배경 패치 매칭 시각화를 확인할 수 있음
   - 매칭 정보는 전경과 배경에 대한 세부 데이터 포함

### API 변경사항

- `memory_system.py`: `get_most_similar_sparse` 메서드에 `match_background` 매개변수 추가
- `memory_sam_predictor.py`: `process_image` 메서드에 `match_background` 매개변수 추가

## 향후 개선 계획

1. 배경 매칭 알고리즘 최적화
2. 전경/배경 가중치 동적 조정 기능
3. 메모리 항목 삭제 및 관리 기능 구현

---

이 업데이트는 코드 품질과 기능을 향상시켜 Memory SAM 시스템의 사용성과 성능을 개선합니다.